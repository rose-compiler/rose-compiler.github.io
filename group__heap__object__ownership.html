<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ROSE: Ownership of heap-allocated objects</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="ROSE"/>
<link href="roseDoxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ROSE<span id="projectnumber">&#160;0.11.145.141</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">Ownership of heap-allocated objects<div class="ingroups"><a class="el" href="group__library__general__principles.html">Library general principles</a></div></div></div>
</div><!--header-->
<div class="contents">
<p>Paradigms for allocation/deallocation of objects. </p>
<p>Any time an object is allocated on the heap the library needs to be clear about who owns that object, i.e., which other object(s) has a pointer to this heap-allocated object. Lack of clear ownership rules leads to either unsafe deletion caused deleting an object when something else is still using it, or memory leaks caused by users not deleting objects because they're afraid of unsafe deletion. A number of ownership paradigms exist:</p>
<p>The <b>single ownership paradigm</b> is when a heap-allocated object has exactly one owner. If the owner object is copied then the heap-allocated object must also be copied so that each owner continues to point to its own singly-owned child. This paradigm usually leads to excessive copying and is not generally used by ROSE.</p>
<p>The <b>shared, no-owner</b> paradigm is when heap-allocated objects can be referenced from multiple parent objects and none of those objects clearly own the heap-allocated object. Thus, none of the parent objects can ever safely delete the heap-allocated object because the parents generally don't know about each other. This obviously leads to memory leaks. This is the paradigm used by most of the older parts of ROSE, such as the parent and child pointers in the AST. Avoid this paradigm in new code if possible since it has been an unending source of problems in ROSE.</p>
<p>The <b>shared ownership</b> paradigm allows multiple parent objects to point to the same heap-allocated child object, and all parents share the ownership of the that child. The parents coordinate with each other so that when the last parent relinquishes ownership then the child object is automatically deleted. This is the paradigm used by most of the binary analysis parts of ROSE.</p>
<h1><a class="anchor" id="heap_object_shared_ownership"></a>
Shared ownership</h1>
<p>Within ROSE, shared ownership is implemented using smart pointers. A smart pointer behaves for the most part like a native C++ pointer, but performs additional functions. The binary analysis parts of ROSE use three shared pointer implementations: <a href="https://en.cppreference.com/w/cpp/memory/shared_ptr">std::shared_ptr</a> for most new code, <a href="https://www.boost.org/doc/libs/1_84_0/libs/smart_ptr/doc/html/smart_ptr.html#shared_ptr">boost::shared_ptr</a> for most legacy code written before ROSE used C++11, and <a class="el" href="classSawyer_1_1SharedPointer.html">Sawyer::SharedPointer</a> for situations that need higher performance.</p>
<p>To make the use of these three implementations more uniform, most objects name their pointer types <code>Ptr</code> and <code>ConstPtr</code>. Since these nested types are not available for forward class declarations when using only the "BasicTypes.h" headers, ROSE also has incomplete pointer definitions named by concatenating the class name with the word "Ptr" and "ConstPtr". For instance, the "BasicTypes.h" headers would declare <code>Foo</code>, <code>FooPtr</code>, and <code>FooConstPtr</code> and the class definition for <code>Foo</code> (probably in a header named "Foo.h") defines <code>Foo::Ptr</code> and <code>Foo::ConstPtr</code>. The concatenated names are usually used in other header files when the class definition is not available (only its declaration), and the qualified (or unqualified when possible) names are used everywhere else.</p>
<p>Objects that support shared ownership in ROSE make their normal constructors private or protected so such objects aren't accidentally allocated on the stack. Instead, they provide a public, static member function usually named "instance" that takes the place of the normal C++ constructors and returns a shared pointer to a newly allocated object. Since the destructors are called automatically, the convention in ROSE is to not document them.</p>
<p>When passing shared pointers as arguments to functions, the convention in ROSE is to pass them as const references. This avoids the book keeping necessary whenever shared pointers are copied. An alternative in the C++ world in general is to pass raw pointers since the caller holds a reference to the object that keeps it from being deleted, but this is suboptimal in ROSE because it splits the API between functions that take smart pointers and those that take raw pointers, making the API less consistent and more difficult for users.</p>
<p>Because reference counting by itself doesn't work well with ownership cycles, and since detecting ownership cycles in C++ is too invasive to the API, ROSE is designed to not use internal data structures that could introduce cycles. If you find a cycle you've found a flaw in the design. On the other hand, nothing prevents the user from creating data structures that cause ownership cycles. Any shared object that can be reached from such a cycle will never be freed until the cycle is broken by the user. One way to break these cycles is to reset one of the cycle's shared-ownership pointers, but the details of which pointer to reset is entirely the responsibility of the person that designed the cyclical data structure. </p>
<div class="dynheader">
Collaboration diagram for Ownership of heap-allocated objects:</div>
<div class="dyncontent">
<div class="center"><img src="group__heap__object__ownership.png" border="0" usemap="#agroup____heap____object____ownership" alt=""/></div>
<map name="agroup____heap____object____ownership" id="agroup____heap____object____ownership">
<area shape="rect" title="Paradigms for allocation/deallocation of objects." alt="" coords="220,5,407,45"/>
<area shape="rect" href="group__library__general__principles.html" title="Information about the ROSE library API in general." alt="" coords="5,13,172,38"/>
</map>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Oct 2 2024 00:08:37 for ROSE by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
